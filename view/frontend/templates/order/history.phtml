<?php
/**
 * MagoArab Order Tracking - Order History Template
 *
 * @category  MagoArab
 * @package   MagoArab_OrderTracking
 * @author    MagoArab Team
 * @var $block \Magento\Sales\Block\Order\History
 */

$_orders = $block->getOrders();
$_helper = $this->helper('MagoArab\OrderTracking\Helper\Data');
?>

<div class="block block-dashboard-orders">
    <?php if ($_orders && $_orders->getSize()): ?>
        <div class="block-title order">
            <strong><?= $block->escapeHtml(__('Recent Orders')) ?></strong>
            <a class="action view" href="<?= $block->escapeUrl($block->getUrl('sales/order/history')) ?>">
                <span><?= $block->escapeHtml(__('View All')) ?></span>
            </a>
        </div>
        <div class="block-content">
            <div class="table-wrapper orders-recent">
                <table class="data table table-order-items recent" id="my-orders-table">
                    <caption class="table-caption"><?= $block->escapeHtml(__('Recent Orders')) ?></caption>
                    <thead>
                        <tr>
                            <th scope="col" class="col id"><?= $block->escapeHtml(__('Order #')) ?></th>
                            <th scope="col" class="col date"><?= $block->escapeHtml(__('Date')) ?></th>
                            <th scope="col" class="col shipping"><?= $block->escapeHtml(__('Ship To')) ?></th>
                            <th scope="col" class="col total"><?= $block->escapeHtml(__('Order Total')) ?></th>
                            <th scope="col" class="col status"><?= $block->escapeHtml(__('Status')) ?></th>
                            <th scope="col" class="col actions"><?= $block->escapeHtml(__('Action')) ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($_orders as $_order): ?>
                            <tr>
                                <td data-th="<?= $block->escapeHtml(__('Order #')) ?>" class="col id">
                                    <a href="<?= $block->escapeUrl($block->getViewUrl($_order)) ?>" title="<?= $block->escapeHtml(__('View Order')) ?>">
                                        <?= $block->escapeHtml($_order->getRealOrderId()) ?>
                                    </a>
                                </td>
                                <td data-th="<?= $block->escapeHtml(__('Date')) ?>" class="col date">
                                    <?= $block->escapeHtml($block->formatDate($_order->getCreatedAt())) ?>
                                </td>
                                <td data-th="<?= $block->escapeHtml(__('Ship To')) ?>" class="col shipping">
                                    <?= $_order->getShippingAddress() ? $block->escapeHtml($_order->getShippingAddress()->getName()) : '&nbsp;' ?>
                                </td>
                                <td data-th="<?= $block->escapeHtml(__('Order Total')) ?>" class="col total">
                                    <?= /* @noEscape */ $_order->formatPrice($_order->getGrandTotal()) ?>
                                </td>
                                <td data-th="<?= $block->escapeHtml(__('Status')) ?>" class="col status">
                                    <?= $block->escapeHtml($_order->getStatusLabel()) ?>
                                </td>
                                <td data-th="<?= $block->escapeHtml(__('Actions')) ?>" class="col actions">
                                    <a href="<?= $block->escapeUrl($block->getViewUrl($_order)) ?>" class="action view">
                                        <span><?= $block->escapeHtml(__('View Order')) ?></span>
                                    </a>
                                    <?php if ($this->helper('Magento\Sales\Helper\Reorder')->canReorder($_order->getEntityId())): ?>
                                        <a href="<?= $block->escapeUrl($block->getReorderUrl($_order)) ?>" class="action order">
                                            <span><?= $block->escapeHtml(__('Reorder')) ?></span>
                                        </a>
                                    <?php endif ?>
                                    <?php if ($_helper->isEnabled()): ?>
                                        <a href="#" 
                                           class="action track-order" 
                                           data-order-id="<?= $block->escapeHtmlAttr($_order->getRealOrderId()) ?>"
                                           title="<?= $block->escapeHtmlAttr(__('Track Order')) ?>">
                                            <span><?= $block->escapeHtml(__('Track Order')) ?></span>
                                        </a>
                                    <?php endif ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    <?php else: ?>
        <div class="message info empty">
            <span><?= $block->escapeHtml(__('You have placed no orders.')) ?></span>
        </div>
    <?php endif ?>
</div>

<?php if ($_helper->isEnabled()): ?>
<script type="text/javascript">
require(['jquery', 'mage/url', 'domReady!'], function($, urlBuilder) {
    // Handle track button click
    $('.track-order').on('click', function(e) {
        e.preventDefault();
        
        var $button = $(this);
        var orderId = $button.data('order-id');
        
        if (!orderId) {
            alert('<?= $block->escapeJs(__('Order ID not found.')) ?>');
            return;
        }
        
        // Add loading state
        $button.addClass('loading').prop('disabled', true);
        
        // Create and submit form
        var trackingUrl = '<?= $block->escapeJs($block->getUrl('ordertracking/order/track')) ?>';
        var formKey = $('input[name="form_key"]').val();
        
        var form = $('<form>', {
            method: 'POST',
            action: trackingUrl,
            style: 'display: none;'
        });
        
        // Add form fields
        form.append($('<input>', {
            type: 'hidden',
            name: 'tracking_type',
            value: 'order_id'
        }));
        
        form.append($('<input>', {
            type: 'hidden',
            name: 'tracking_value',
            value: orderId
        }));
        
        if (formKey) {
            form.append($('<input>', {
                type: 'hidden',
                name: 'form_key',
                value: formKey
            }));
        }
        
        // Submit form
        $('body').append(form);
        form.submit();
    });
    
    // Add hover effects
    $('.track-order').hover(
        function() {
            $(this).addClass('hover');
        },
        function() {
            $(this).removeClass('hover');
        }
    );
});
</script>
<?php endif ?>